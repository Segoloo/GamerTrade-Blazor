@page "/product"
@layout AdminLayout

<section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-8 mb-12 sm:mb-16">
    <div class="bg-white/80 rounded-xl shadow p-6 pb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <h2 class="text-xl font-bold">Gestionar Productos</h2>
            <div class="flex items-center gap-2">
                <input class="border rounded px-3 py-2 text-sm w-60" placeholder="Buscar productos..." @bind="_query" />
                <button class="inline-flex items-center rounded bg-neutral-200 text-neutral-900 px-3 py-2 text-sm font-semibold hover:bg-neutral-300" @onclick="ToggleAllCats">@(_allExpanded ? "Contraer Todo" : "Expandir Todo")</button>
                <button class="inline-flex items-center gap-2 rounded bg-purple-600 text-white px-4 py-2 font-semibold hover:bg-purple-700" @onclick="AddProduct">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 4v16M4 12h16"/></svg>
                    Agregar Producto
                </button>
            </div>
        </div>

        <div class="mt-4 space-y-4">
            @if (_products.Any())
            {
                var map = _categories?.ToDictionary(c => c.Id, c => c.Name) ?? new Dictionary<Guid, string>();
                var filtered = _products
                    .Where(p => string.IsNullOrWhiteSpace(_query) || (p.Name?.Contains(_query, StringComparison.OrdinalIgnoreCase) ?? false))
                    .ToList();
                var groups = filtered
                    .GroupBy(p => p.CategoryId ?? Guid.Empty)
                    .Select(g => new { Key = g.Key, Name = (g.Key != Guid.Empty && map.TryGetValue(g.Key, out var n) ? n : "(Sin categoría)"), Items = g.ToList() })
                    .OrderBy(g => g.Name)
                    .ToList();

                @foreach (var g in groups)
                {
                    bool isOpen = _expandedCats.Contains(g.Key);
                    <article class="rounded border">
                        <button type="button" class="w-full px-4 py-2 bg-neutral-100 flex items-center justify-between" @onclick="() => ToggleCat(g.Key)">
                            <div class="font-semibold">@g.Name</div>
                            <div class="text-sm">Cantidad: <b>@g.Items.Count</b></div>
                        </button>

                        @if (isOpen)
                        {
                            <div class="p-3 overflow-x-auto">
                                <table class="min-w-full text-sm">
                                    <thead>
                                        <tr class="bg-neutral-50 text-left">
                                            <th class="px-3 py-2">Id</th>
                                            <th class="px-3 py-2">Imagen</th>
                                            <th class="px-3 py-2">Nombre</th>
                                            <th class="px-3 py-2">Descripción</th>
                                            <th class="px-3 py-2">Precio</th>
                                            <th class="px-3 py-2">Cantidad</th>
                                            <th class="px-3 py-2">Fecha Creación</th>
                                            <th class="px-3 py-2 text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-neutral-200">
                                        @foreach (var product in g.Items)
                                        {
                                            <tr>
                                                <td class="px-3 py-2 align-top">@product.Id</td>
                                                <td class="px-3 py-2 align-top"><img src="@product.Image" alt="@product.Name" class="h-12 w-12 object-cover rounded" /></td>
                                                <td class="px-3 py-2 align-top">@product.Name</td>
                                                <td class="px-3 py-2 align-top">@product.Description</td>
                                                <td class="px-3 py-2 align-top">@product.Price</td>
                                                <td class="px-3 py-2 align-top">@product.Quantity</td>
                                                <td class="px-3 py-2 align-top">@product.CreatedOn</td>
                                                <td class="px-3 py-2 align-top">
                                                    <div class="flex items-center justify-center gap-3">
                                                        <button class="text-blue-600 hover:text-blue-700" title="Editar" @onclick="async () => await StartEdit(product)">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
                                                        </button>
                                                        <button class="text-red-600 hover:text-red-700" title="Eliminar" @onclick="() => ConfirmDelete(product.Id)">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 7h12M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2m-1 0l-1 12a2 2 0 01-2 2h-2a2 2 0 01-2-2L8 7"/></svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </article>
                }
            }
            else
            {
                <div class="mt-6 rounded-md bg-purple-50 text-purple-800 px-6 py-5 text-center shadow font-semibold">
                    No se encontraron productos.
                </div>
            }
        </div>
    </div>
</section>

<ModalDialog @bind-IsVisible="_showDialog" Size="xl">
    <Header>
        <div class="flex items-center justify-between w-full">
            <h5 class="text-lg font-semibold">@(!_addStep2 ? "Agregar Nuevo Producto" : "Agregar Variantes")</h5>
            @if (_addStep2)
            {
                <span class="text-xs text-neutral-500">Paso 2 de 2</span>
            }
            else
            {
                <span class="text-xs text-neutral-500">Paso 1 de 2</span>
            }
        </div>
    </Header>
    <Body>
        @if (!_addStep2)
        {
            <EditForm Model="_product" OnValidSubmit="SaveProduct">
                <DataAnnotationsValidator />
                <div class="form-group mb-3">
                    <label class="block text-xs text-neutral-600 mb-1">Nombre del Producto</label>
                    <InputText @bind-Value="_product.Name" class="w-full border rounded px-3 py-2" />
                    <ValidationMessage For="@(() => _product.Name)" />
                </div>
                <div class="form-group mb-3">
                    <label class="block text-xs text-neutral-600 mb-1">Precio</label>
                    <InputNumber @bind-Value="_product.Price" class="w-full border rounded px-3 py-2" />
                    <ValidationMessage For="@(() => _product.Price)" />
                </div>
                <div class="form-group mb-3">
                    <label class="block text-xs text-neutral-600 mb-1">Cantidad</label>
                    <InputNumber @bind-Value="_product.Quantity" class="w-full border rounded px-3 py-2" />
                    <ValidationMessage For="@(() => _product.Quantity)" />
                </div>
                <div class="form-group mb-3">
                    <label class="block text-xs text-neutral-600 mb-1">Descripción del Producto</label>
                    <InputTextArea @bind-Value="_product.Description" class="w-full border rounded px-3 py-2" />
                    <ValidationMessage For="@(() => _product.Description)" />
                </div>
                <div class="form-group mb-3">
                    <label for="category" class="block text-xs text-neutral-600 mb-1">Categoría</label>
                    <InputSelect id="category" class="w-full border rounded px-3 py-2" @bind-Value="_product.CategoryId">
                        <option value="" selected>-- Seleccionar una Categoría --</option>
                        @foreach (var category in _categories)
                        {
                            <option value="@category.Id">@category.Name</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => _product.CategoryId)" />
                </div>
                <div class="form-group mb-3 flex items-center justify-between">
                    <label class="inline-flex items-center gap-2 rounded bg-purple-600 text-white px-4 py-2 font-semibold hover:bg-purple-700 cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 5v14m7-7H5"/></svg>
                        <span>Subir Imagen</span>
                        <InputFile OnChange="EventCallback.Factory.Create<InputFileChangeEventArgs>(this, OnFileSelected)" accept="image/*" class="sr-only" />
                    </label>
                    @if (!string.IsNullOrEmpty(_previewImageUrl))
                    {
                        <img src="@_previewImageUrl" alt="Vista previa" class="ml-4 max-w-24 max-h-24 border rounded" />
                    }
                    <ValidationMessage For="@(() => _product.Image)" />
                </div>
            </EditForm>
        }
        else
        {
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="col-span-2">
                    <div class="mt-3 grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">Escala de Tamaño</label>
                            <select class="w-full border rounded px-3 py-2" @onchange="OnScaleChangedAdd" value="@_newVariantForm.SizeScale">
                                <option value="1">Ropa (XS-XXL)</option>
                                <option value="2">Ropa Numérica EU</option>
                                <option value="10">Zapatos EU</option>
                                <option value="11">Zapatos US</option>
                                <option value="12">Zapatos UK</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">Tamaño</label>
                            <select class="w-full border rounded px-3 py-2" @bind="_newVariantForm.SizeValue">
                                @foreach (var v in GetSizeOptions(_newVariantForm.SizeScale))
                                {
                                    <option value="@v">@v</option>
                                }
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">SKU</label>
                            <InputText @bind-Value="_newVariantForm.Sku" class="w-full border rounded px-3 py-2" />
                        </div>
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">Precio (opcional)</label>
                            <InputNumber @bind-Value="_newVariantForm.Price" class="w-full border rounded px-3 py-2" />
                        </div>
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">Stock</label>
                            <InputNumber @bind-Value="_newVariantForm.Stock" class="w-full border rounded px-3 py-2" />
                        </div>
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">Color (opcional)</label>
                            <InputText @bind-Value="_newVariantForm.Color" class="w-full border rounded px-3 py-2" />
                        </div>
                        <div class="col-span-2 flex items-center gap-3">
                            <input id="isDefaultNew" type="checkbox" @bind="_newVariantForm.IsDefault" class="h-4 w-4" />
                            <label for="isDefaultNew" class="text-sm">Establecer como predeterminado</label>
                            <div class="ml-auto">
                                <button type="button" class="inline-flex items-center rounded bg-purple-600 text-white px-3 py-1.5 font-semibold hover:bg-purple-700" @onclick="AddVariantForNewAsync">Agregar Variante</button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 overflow-auto max-h-64">
                        <table class="min-w-full text-xs">
                            <thead>
                                <tr class="bg-neutral-100 text-left">
                                    <th class="px-2 py-1">Escala</th>
                                    <th class="px-2 py-1">Tamaño</th>
                                    <th class="px-2 py-1">SKU</th>
                                    <th class="px-2 py-1">Precio</th>
                                    <th class="px-2 py-1">Stock</th>
                                    <th class="px-2 py-1">Color</th>
                                    <th class="px-2 py-1">Predeterminado</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-neutral-200">
                                @foreach (var v in _newVariants)
                                {
                                    <tr>
                                        <td class="px-2 py-1">@ScaleLabel(v.SizeScale)</td>
                                        <td class="px-2 py-1">@v.SizeValue</td>
                                        <td class="px-2 py-1">@v.Sku</td>
                                        <td class="px-2 py-1">@(v.Price?.ToString() ?? "—")</td>
                                        <td class="px-2 py-1">@v.Stock</td>
                                        <td class="px-2 py-1">@v.Color</td>
                                        <td class="px-2 py-1">@(v.IsDefault ? "Sí" : "No")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </Body>
    <Footer>
        @if (!_addStep2)
        {
            <button class="inline-flex items-center rounded bg-purple-600 text-white px-4 py-2 font-semibold hover:bg-purple-700" type="button" @onclick="() => InvokeAsync(() => SaveProduct())">Guardar y Continuar</button>
            <button class="inline-flex items-center rounded bg-red-600 text-white px-4 py-2 font-semibold hover:bg-red-700" type="button" @onclick="Cancel">Cancelar</button>
        }
        else
        {
            <button class="inline-flex items-center rounded bg-neutral-200 text-neutral-900 px-4 py-2 font-semibold hover:bg-neutral-300" type="button" @onclick="Cancel">Cerrar</button>
            <button class="inline-flex items-center rounded bg-purple-600 text-white px-4 py-2 font-semibold hover:bg-purple-700" type="button" @onclick="FinishAdd">Finalizar</button>
        }
    </Footer>
</ModalDialog>

<ModalDialog @bind-IsVisible="_showEditDialog" Size="xl">
    <Header>
        <h5 class="text-lg font-semibold">Editar Producto</h5>
    </Header>
    <Body>
        <EditForm Model="_editProduct" OnValidSubmit="UpdateProductAsync">
            <DataAnnotationsValidator />
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div class="form-group mb-3">
                        <label class="block text-xs text-neutral-600 mb-1">Nombre del Producto</label>
                        <InputText @bind-Value="_editProduct.Name" class="w-full border rounded px-3 py-2" />
                        <ValidationMessage For="@(() => _editProduct.Name)" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="block text-xs text-neutral-600 mb-1">Precio</label>
                        <InputNumber @bind-Value="_editProduct.Price" class="w-full border rounded px-3 py-2" />
                        <ValidationMessage For="@(() => _editProduct.Price)" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="block text-xs text-neutral-600 mb-1">Cantidad</label>
                        <InputNumber @bind-Value="_editProduct.Quantity" class="w-full border rounded px-3 py-2" />
                        <ValidationMessage For="@(() => _editProduct.Quantity)" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="block text-xs text-neutral-600 mb-1">Descripción del Producto</label>
                        <InputTextArea @bind-Value="_editProduct.Description" class="w-full border rounded px-3 py-2" />
                        <ValidationMessage For="@(() => _editProduct.Description)" />
                    </div>
                    <div class="form-group mb-3">
                        <label for="edit-category" class="block text-xs text-neutral-600 mb-1">Categoría</label>
                        <InputSelect id="edit-category" class="w-full border rounded px-3 py-2" @bind-Value="_editProduct.CategoryId">
                            <option value="" selected>-- Seleccionar una Categoría --</option>
                            @foreach (var category in _categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => _editProduct.CategoryId)" />
                    </div>
                    <div class="form-group mb-3">
                        <label class="block text-xs text-neutral-600 mb-1">Imagen</label>
                        <div class="flex items-center justify-between">
                            <label class="inline-flex items-center gap-2 rounded bg-purple-600 text-white px-4 py-2 font-semibold hover:bg-purple-700 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 5v14m7-7H5"/></svg>
                                <span>Subir Imagen</span>
                                <InputFile OnChange="EventCallback.Factory.Create<InputFileChangeEventArgs>(this, OnEditFileSelected)" accept="image/*" class="sr-only" />
                            </label>
                            @if (!string.IsNullOrEmpty(_previewImageUrl))
                            {
                                <img src="@_previewImageUrl" alt="Vista previa" class="ml-4 max-w-24 max-h-24 border rounded" />
                            }
                        </div>
                        <ValidationMessage For="@(() => _editProduct.Image)" />
                    </div>
                </div>

                <div>
                    <div class="flex items-center justify-between">
                        <h6 class="text-base font-semibold">Variantes</h6>
                        @if (_editingVariantId is not null)
                        {
                            <span class="text-xs text-neutral-500">Editando variante</span>
                        }
                    </div>

                    <div class="mt-3 grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">Escala de Tamaño</label>
                            <select class="w-full border rounded px-3 py-2" @onchange="OnScaleChanged" value="@_variantForm.SizeScale">
                                <option value="1">Ropa (XS-XXL)</option>
                                <option value="2">Ropa Numérica EU</option>
                                <option value="10">Zapatos EU</option>
                                <option value="11">Zapatos US</option>
                                <option value="12">Zapatos UK</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">Tamaño</label>
                            <select class="w-full border rounded px-3 py-2" @bind="_variantForm.SizeValue">
                                @foreach (var v in GetSizeOptions(_variantForm.SizeScale))
                                {
                                    <option value="@v">@v</option>
                                }
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">SKU</label>
                            <InputText @bind-Value="_variantForm.Sku" class="w-full border rounded px-3 py-2" />
                        </div>
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">Precio (opcional)</label>
                            <InputNumber @bind-Value="_variantForm.Price" class="w-full border rounded px-3 py-2" />
                        </div>
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">Stock</label>
                            <InputNumber @bind-Value="_variantForm.Stock" class="w-full border rounded px-3 py-2" />
                        </div>
                        <div>
                            <label class="block text-xs text-neutral-600 mb-1">Color (opcional)</label>
                            <InputText @bind-Value="_variantForm.Color" class="w-full border rounded px-3 py-2" />
                        </div>
                        <div class="col-span-2 flex items-center gap-3">
                            <input id="isDefault" type="checkbox" @bind="_variantForm.IsDefault" class="h-4 w-4" />
                            <label for="isDefault" class="text-sm">Establecer como predeterminado</label>
                            <div class="ml-auto flex gap-2">
                                @if (_editingVariantId is null)
                                {
                                    <button type="button" class="inline-flex items-center rounded bg-purple-600 text-white px-3 py-1.5 font-semibold hover:bg-purple-700" @onclick="AddVariantAsync">Agregar Variante</button>
                                }
                                else
                                {
                                    <button type="button" class="inline-flex items-center rounded bg-purple-600 text-white px-3 py-1.5 font-semibold hover:bg-purple-700" @onclick="UpdateVariantAsync">Actualizar Variante</button>
                                    <button type="button" class="inline-flex items-center rounded bg-neutral-200 text-neutral-900 px-3 py-1.5 font-semibold hover:bg-neutral-300" @onclick="CancelVariantEdit">Cancelar</button>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 overflow-auto max-h-64">
                        <table class="min-w-full text-xs">
                            <thead>
                                <tr class="bg-neutral-100 text-left">
                                    <th class="px-2 py-1">Escala</th>
                                    <th class="px-2 py-1">Tamaño</th>
                                    <th class="px-2 py-1">SKU</th>
                                    <th class="px-2 py-1">Precio</th>
                                    <th class="px-2 py-1">Stock</th>
                                    <th class="px-2 py-1">Color</th>
                                    <th class="px-2 py-1">Predeterminado</th>
                                    <th class="px-2 py-1 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-neutral-200">
                                @foreach (var v in _variants)
                                {
                                    <tr>
                                        <td class="px-2 py-1">@ScaleLabel(v.SizeScale)</td>
                                        <td class="px-2 py-1">@v.SizeValue</td>
                                        <td class="px-2 py-1">@v.Sku</td>
                                        <td class="px-2 py-1">@(v.Price?.ToString() ?? "—")</td>
                                        <td class="px-2 py-1">@v.Stock</td>
                                        <td class="px-2 py-1">@v.Color</td>
                                        <td class="px-2 py-1">@(v.IsDefault ? "Sí" : "No")</td>
                                        <td class="px-2 py-1 text-center">
                                            <button class="text-blue-600 hover:text-blue-700 mr-2" title="Editar" @onclick="() => BeginVariantEdit(v)">Editar</button>
                                            <button class="text-red-600 hover:text-red-700" title="Eliminar" @onclick="() => DeleteVariantAsync(v.Id)">Eliminar</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <hr class="mt-6" />
            <div class="flex justify-end gap-2 mt-4">
                <button class="inline-flex items-center rounded bg-purple-600 text-white px-4 py-2 font-semibold hover:bg-purple-700" type="submit">Actualizar</button>
                <button class="inline-flex items-center rounded bg-red-600 text-white px-4 py-2 font-semibold hover:bg-red-700" type="button" @onclick="CancelEdit">Cancelar</button>
            </div>
        </EditForm>
    </Body>
</ModalDialog>

<ModalDialog @bind-IsVisible="_showConfirmDeleteDialog">
    <Header>
        <h5 class="text-lg font-semibold">Confirmar Eliminación</h5>
    </Header>
    <Body>
        ¿Estás seguro de que deseas eliminar el producto
        <span class="text-red-600"><strong>@_producToDeleteName</strong></span>?
    </Body>
    <Footer>
        <button class="inline-flex items-center rounded bg-red-600 text-white px-4 py-2 font-semibold hover:bg-red-700" @onclick="DeleteProductConfirmed">Sí, Eliminar</button>
        <button class="inline-flex items-center rounded bg-neutral-200 text-neutral-900 px-4 py-2 font-semibold hover:bg-neutral-300" @onclick="CancelDelete">Cancelar</button>
    </Footer>
</ModalDialog>